<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OZEU Guild Joiner</title>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #202225; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #5865f2; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #7289da; }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg,#2f3136,#1e1f22);
            color:#fff;
            margin:0; padding:0;
            display:flex; justify-content:center; align-items:center;
            height:100vh;
        }
        .card {
            background:#36393f;
            padding:32px;
            border-radius:20px;
            box-shadow:0 15px 35px rgba(0,0,0,.5);
            width:100%; max-width:600px;
            animation: fadeIn 0.6s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            overflow:auto; max-height:95vh;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        h2 { color:#adb8ff; text-align:center; margin:0 0 24px; font-weight:600; }
        label { display:block; margin-top:18px; font-size:14px; }

        input[type="text"], textarea {
            width:100%; padding:10px; margin-top:6px;
            border-radius:8px; border:none;
            background:#202225; color:#fff;
            font-family:monospace; resize:vertical;
        }
        textarea { overflow-y:auto; }
        input[type="number"] {
            padding:6px; margin-top:6px;
            border-radius:8px; border:none;
            background:#202225; color:#fff;
            font-family:monospace; appearance:none;
            width:80px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance:none; margin:0;
        }
        input[type="file"] { display: none; }
        .row { display:flex; gap:12px; align-items:center; }
        .row > * { flex:none; }
        .row label,
        .row .checkbox-container { margin-top:0; }


        .checkbox-container {
            display:flex; align-items:center; gap:8px;
            cursor:pointer; font-size:14px; user-select:none;
            margin-top:6px;
        }
        .checkbox-container input {
            appearance:none; width:36px; height:18px;
            background:#4f545c; border-radius:18px;
            position:relative; transition:background .3s ease;
        }
        .checkbox-container:hover input { background:#5a5f68; }
        .checkbox-container input:focus {
            outline:none; box-shadow:0 0 0 3px rgba(114,137,218,0.5);
        }
        .checkbox-container input::before {
            content:''; position:absolute;
            width:14px; height:14px; border-radius:50%;
            background:#fff; top:2px; left:2px;
            transition:transform .3s cubic-bezier(.68,-.55,.27,1.55);
        }
        .checkbox-container input:checked { background:#7289da; }
        .checkbox-container input:checked::before {
            transform:translateX(18px);
        }
        .checkbox-container span { transition:color .3s; }
        .checkbox-container input:checked + span {
            color:#adb8ff;
        }


        button.primary {
            margin-top:24px; width:100%; padding:14px;
            border:none; border-radius:14px;
            background:linear-gradient(135deg,#6d75ff,#5865f2);
            color:#fff; font-weight:700; font-size:18px;
            letter-spacing:.5px; cursor:pointer; position:relative;
            box-shadow:
                0 4px 15px rgba(88,101,242,.4),
                0 0 10px rgba(255,255,255,.1),
                inset 0 0 5px rgba(255,255,255,.2);
            overflow:hidden; transition:all .3s;
        }
        button.primary:hover {
            background:linear-gradient(135deg,#7d89ff,#4e57e0);
            box-shadow:
                0 6px 22px rgba(88,101,242,.6),
                0 0 24px rgba(255,255,255,.2),
                inset 0 0 10px rgba(255,255,255,.3);
            transform:scale(1.03);
        }
        button.primary:active {
            transform:scale(0.96);
            box-shadow:inset 0 4px 6px rgba(0,0,0,.3);
        }
        button.primary.loading {
            color: #ffffffa2; pointer-events:none;
        }
        button.secondary, .file-upload-btn {
            margin-top:8px; padding:6px 12px;
            background:#5865f2; color:#fff;
            font-size:14px; border:none; border-radius:6px;
            position:relative; overflow:hidden;
            cursor:pointer; display:inline-block;
            text-align:center; user-select:none;
        }
        button.secondary::after, .file-upload-btn::after {
            content:''; position:absolute;
            top:0; left:0; width:100%; height:100%;
            background:rgba(255,255,255,0.1);
            opacity:0; transition:opacity .3s;
        }
        button.secondary:hover::after, .file-upload-btn::hover::after { 
            opacity:1; 
        }
        button.secondary:active::after, .file-upload-btn:active::after { 
            background:rgba(255,255,255,0.2); 
        }
        .file-info {
            margin-top: 4px;
            font-size: 12px;
            color: #adb8ff;
            font-style: italic;
        }

        details { margin-top:18px; }
        summary {
            list-style:none; padding-left:20px; cursor:pointer; font-weight:600;
            position:relative; margin-top:0; user-select:none;
        }
        summary::-webkit-details-marker { display:none; }
        summary::marker { content:none; }
        summary::before {
            content:'‚ñ∂'; position:absolute; left:0; top:50%;
            transform:translateY(-50%); 
            transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        details[open] > summary::before {
            transform:translateY(-50%) rotate(90deg);
        }

        .detail-content {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
            
            padding-top: 0;
            transition: max-height 0.3s ease-out, 
                        opacity 0.2s ease-out, 
                        transform 0.3s ease-out, 
                        padding-top 0.3s ease-out;
            will-change: max-height, opacity, transform, padding-top;
        }
        
        details[open] .detail-content {
            opacity: 1;
            transform: translateY(0);
            padding-top: 5px;
            transition: max-height 0.3s ease-in, 
                        opacity 0.3s ease-in, 
                        transform 0.3s ease-in, 
                        padding-top 0.3s ease-in;
        }

        .option-item {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }

        details[open] .option-item {
            animation: popIn 0.5s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
            animation-delay: var(--animation-delay, 0s);
        }

        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #log {
            margin-top:20px; padding:10px; height:120px; overflow-y:auto;
            background:#202225; border-radius:10px;
            font-family:monospace; font-size:12px; white-space:pre-wrap; resize: vertical;
        }
        @media (max-width: 600px) {
            .card {
                padding: 16px;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 10px;
            }
            h2 { font-size: 18px; margin-bottom: 16px; }
            label { font-size: 13px; margin-top: 12px; }
            input[type="text"],
            textarea,
            input[type="number"] { padding: 8px; font-size: 12px; }
            button.primary { padding: 12px; font-size: 16px; }
            button.secondary, .file-upload-btn { padding: 8px 12px; font-size: 13px; }
            .row { flex-direction: column; align-items: stretch; }
            .row label { width: 100%; }
            .button-container { flex-direction: column; gap: 8px; }
            details summary { font-size: 13px; padding-left: 18px; }
            .checkbox-container { font-size: 13px; }
            #log { height: 80px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>OZEU Guild Joiner</h2>
        <form id="joinForm">
            <label>„Éà„Éº„ÇØ„É≥
                <textarea id="tokens" rows="4" placeholder="„Ç´„É≥„Éû / ÊîπË°å / „Çπ„Éö„Éº„Çπ„ÅßÂå∫Âàá„Çã MTM1ODc4MTE3NTIzMzI1MzU*****,MTEwMDU5Njc1NjQ1NjE2MTMwM*****,..."></textarea>
            </label>
            <label>ÊãõÂæÖ„Ç≥„Éº„Éâ
                <input type="text" id="invite" placeholder="ozeu-x" />
            </label>
            <button id="startJoin" type="button" class="primary">JoinÈñãÂßã</button>

            <details>
                <summary>Advanced Options</summary>
                <div class="detail-content">
                    <label class="option-item">„Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†
                        <input type="text" id="serverNickname" placeholder="discord.gg/..." />
                    </label>
                    
                    <label class="option-item">„Éó„É≠„Éï„Ç£„Éº„É´„É°„ÉÉ„Çª„Éº„Ç∏
                        <textarea type="text" rows="2" id="bioInput" placeholder="ÂÖ•Âäõ„Å™„Åó„ÅßÁÑ°Âäπ" ></textarea>
                        
                    </label>
                    <div class="checkbox-container option-item">
                        <input type="checkbox" id="boostCheckbox" />
                        <span>„Çµ„Éº„Éê„Éº„Éñ„Éº„Çπ„Éà„Åô„Çã</span>
                    </div>
                    <div class="checkbox-container option-item">
                        <input type="checkbox" id="reportCheckbox" />
                        <span>„Çµ„Éº„Éê„Éº„ÇíÈÄöÂ†±„Åô„Çã</span>
                    </div>
                    <label class="option-item">ÁµµÊñáÂ≠ó„Çí„Å§„Åë„Çã„É°„ÉÉ„Çª„Éº„Ç∏URL
                        <input type="text" id="messageUrl" placeholder="ÂÖ•Âäõ„Å™„Åó„ÅßÁÑ°Âäπ" />
                    </label>
                    <label class="option-item">24Captcha API„Ç≠„Éº
                        <input type="text" id="captchaApiKey" placeholder="ÂÖ•Âäõ„Åô„Çã„Å®Join„ÅåÈÅÖ„Åè„Å™„Çã" />
                    </label>
                    </div>
            </details>
            </form>

        <div id="log" style="white-space: pre-wrap; margin-top: 16px; height: 120px; overflow-y: auto;
            background: #202225; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px;"></div>

        <label>JoinÊàêÂäü„Éà„Éº„ÇØ„É≥
            <textarea id="successTokens" rows="4" readonly placeholder="ÊàêÂäü„Åó„Åü„Éà„Éº„ÇØ„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
        </label>
        <button id="copySuccess" class="secondary">„Ç≥„Éî„Éº</button>

        <label>JoinÂ§±Êïó„Éà„Éº„ÇØ„É≥
            <textarea id="failedTokens" rows="4" readonly placeholder="Â§±Êïó„Åó„Åü„Éà„Éº„ÇØ„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
        </label>
        <button id="copyFailed" class="secondary">„Ç≥„Éî„Éº</button>
    </div>

    <script>
        document.querySelectorAll('details').forEach((det)=>{
            const sum = det.querySelector('summary');
            const content = det.querySelector('.detail-content');
            if(!sum || !content) return;

            const T = 'max-height .3s ease, opacity .25s ease, transform .3s ease';

            function openAnim(){
                const optionItems = det.querySelectorAll('.option-item');
                const delayTime = 0.07;
                optionItems.forEach((item, index) => {
                    item.style.setProperty('--animation-delay', `${index * delayTime}s`);
                    item.style.animation = 'none';
                    item.offsetHeight;
                    item.style.animation = '';
                });

                content.style.transition = 'none';
                content.style.willChange = 'max-height, opacity, transform';
                content.style.maxHeight = '0px';
                content.style.opacity   = '0';
                content.style.transform = 'translateY(-10px)';

                content.offsetHeight;
                requestAnimationFrame(()=>{
                    content.style.transition = T;

                    const h = content.scrollHeight;
                    content.style.maxHeight = h + 'px';
                    content.style.opacity   = '1';
                    content.style.transform = 'translateY(0)';

                    const onEnd = (e)=>{
                        if(e.propertyName !== 'max-height') return;
                        content.style.maxHeight = 'none';
                        content.style.willChange = '';
                        content.removeEventListener('transitionend', onEnd);
                    };
                    content.addEventListener('transitionend', onEnd);
                });
            }

            function closeAnim(){
                const h = content.scrollHeight;
                content.style.transition = 'none';
                content.style.willChange = 'max-height, opacity, transform';
                content.style.maxHeight = h + 'px';
                content.style.opacity   = '1';
                content.style.transform = 'translateY(0)';
                content.offsetHeight;

                requestAnimationFrame(()=>{
                    content.style.transition = T;
                    content.style.maxHeight = '0px';
                    content.style.opacity   = '0';
                    content.style.transform = 'translateY(-10px)';

                    const onEnd = (e)=>{
                        if(e.propertyName !== 'max-height') return;
                        det.open = false;
                        content.style.willChange = '';
                        content.removeEventListener('transitionend', onEnd);
                    };
                    content.addEventListener('transitionend', onEnd);
                });
            }

            det.addEventListener('toggle', () => {
                if(det.open){
                    openAnim();
                }
            });

            sum.addEventListener('click', (ev) => {
                if(!det.open) return;
                ev.preventDefault();
                closeAnim();
            });
        });

    </script>
    <script>
        const x_super_properties = "eyJvcyI6IldpbmRvd3MiLCJicm93c2VyIjoiQ2hyb21lIiwiZGV2aWNlIjoiIiwic3lzdGVtX2xvY2FsZSI6ImVuLVVTIiwiaGFzX2NsaWVudF9tb2RzIjpmYWxzZSwiYnJvd3Nlcl91c2VyX2FnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM6IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEzNi4wLjAuMCBTYWZhcmkvNTM3LjM2IiwiYnJvd3Nlcl92ZXJzaW9uIjoiMTM2LjAuMC4wIiwib3NfdmVyc2lvbiI6IjEwIiwicmVmZXJyZXIiOiIiLCJyZWZlcnJpbmdfZG9tYWluIjoiIiwicmVmZXJyZXJfY3VycmVudCI6IiIsInJlZmVycmluZ19kb21haW5fY3VycmVudCI6IiIsInJlbGVhc2VfY2hhbm5lbCI6InN0YWJsZSIsImNsaWVudF9idWlsZF9udW1iZXIiOjQwNDAyMywiY2xpZW50X2V2ZW50X3NvdXJjZSI6bnVsbCwiY2xpZW50X2xhdW5jaF9pZCI6IjE2NTQzODdmLTg2NmItNDE2Ni04Zjc3LTM1ZDk2NGI3NjRmMyIsImNsaWVudF9hcHBfc3RhdGUiOiJmb2N1c2VkIn0=";
        const user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36";
        const logEl = document.getElementById('log');
        let config;

        fetch('/config.json')
            .then(response => response.json())
            .then(data => {
                config = data;
            });

        function appendLog(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `\n${time} - ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function parseList(input) {
            return input.split(/[\s,]+/)
                .map(s => s.trim())
                .filter(Boolean);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                appendLog('üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            } catch (e) {
                appendLog('‚ö†Ô∏è „Ç≥„Éî„ÉºÂ§±Êïó: ' + e);
            }
        }

        function getCurrentDateTimeString() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
            };
            return now.toLocaleDateString('en-US', options) + ' at ' + 
                now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        const startBtn             = document.getElementById('startJoin');
        const successArea          = document.getElementById('successTokens');
        const failedArea           = document.getElementById('failedTokens');
        const copySucc             = document.getElementById('copySuccess');
        const copyFail             = document.getElementById('copyFailed');
        const tokensInput          = document.getElementById('tokens');
        const inviteInput          = document.getElementById('invite');
        const serverNicknameInput  = document.getElementById('serverNickname');
        // globalNicknameInput ÂâäÈô§
        // avatarInput ÂâäÈô§
        // avatarBtn ÂâäÈô§
        // avatarInfo ÂâäÈô§
        const bioInput             = document.getElementById('bioInput');
        const boostCheckbox        = document.getElementById('boostCheckbox');
        const reportCheckbox       = document.getElementById('reportCheckbox'); // ËøΩÂä†
        const messageUrlInput      = document.getElementById('messageUrl');
        const captchaApiKeyInput   = document.getElementById('captchaApiKey');

        // „Ç¢„Éê„Çø„ÉºÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ÂâäÈô§

        copySucc.addEventListener('click', () => copyToClipboard(successArea.value));
        copyFail.addEventListener('click', () => copyToClipboard(failedArea.value));

        async function getTopReactionFromMessage(messageUrl, token) {
            try {
                const urlParts = messageUrl.split('/');
                if (urlParts.length < 6 || !urlParts[4] || !urlParts[5] || !urlParts[6]) {
                    throw new Error('ÁÑ°Âäπ„Å™„É°„ÉÉ„Çª„Éº„Ç∏URLÂΩ¢Âºè');
                }
                
                const channelId = urlParts[5];
                const messageId = urlParts[6];
                
                const response = await fetch(`https://discord.com/api/v9/channels/${channelId}/messages?limit=1&around=${messageId}`, {
                    headers: {
                        'Authorization': token,
                        'User-Agent': user_agent,
                        'Content-Type': 'application/json',
                        'x-super-properties': x_super_properties
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæóÂ§±Êïó: ${response.status}`);
                }
                
                const messages = await response.json();
                if (!messages || messages.length === 0) {
                    throw new Error('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                const message = messages[0];
                const reactions = message.reactions || [];
                
                if (reactions.length === 0) {
                    throw new Error('„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
                }
                
                // ÊúÄ„ÇÇÂ§ö„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂèñÂæó
                const topReaction = reactions.reduce((max, current) => 
                    current.count > max.count ? current : max
                );
                
                const emoji = topReaction.emoji;
                const emojiName = emoji.name;
                const emojiId = emoji.id;
                
                let emojiEncoded;
                if (emojiId) {
                    // „Ç´„Çπ„Çø„É†ÁµµÊñáÂ≠ó: name:id
                    emojiEncoded = `${emojiName}:${emojiId}`;
                } else {
                    // UnicodeÁµµÊñáÂ≠ó: URL„Ç®„É≥„Ç≥„Éº„Éâ
                    emojiEncoded = encodeURIComponent(emojiName);
                }
                
                return {
                    channelId,
                    messageId,
                    emojiEncoded,
                    emojiName,
                    emojiId,
                    count: topReaction.count
                };
            } catch (error) {
                throw new Error(`„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
            }
        }

        async function addReactionToMessage(channelId, messageId, emojiEncoded, token) {
            try {
                const response = await fetch(
                    `https://discord.com/api/v9/channels/${channelId}/messages/${messageId}/reactions/${emojiEncoded}/@me`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': token,
                            'User-Agent': user_agent,
                            'Content-Type': 'application/json',
                            'x-super-properties': x_super_properties
                        }
                    }
                );
                
                return {
                    success: response.status === 204,
                    status: response.status,
                    statusText: response.statusText
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        startBtn.addEventListener('click', async () => {
            const tokens     = parseList(tokensInput.value);
            const rawInvite  = inviteInput.value.trim();
            const messageUrl = messageUrlInput.value.trim();
            const captchaApiKey = captchaApiKeyInput.value.trim();
            
            if (!tokens.length) {
                appendLog('‚ö†Ô∏è „Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            if (!rawInvite) {
                appendLog('‚ö†Ô∏è ÊãõÂæÖ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            startBtn.disabled   = true;
            startBtn.textContent = 'ÂÆüË°å‰∏≠...';
            startBtn.classList.add('loading');
            successArea.value   = '';
            failedArea.value    = '';
            logEl.textContent   = '';
            appendLog('üü¢ JoinÂá¶ÁêÜ„ÇíÈñãÂßã');

            const inviteParts = rawInvite.split('/').filter(Boolean);
            const inviteCode  = inviteParts[inviteParts.length - 1];
            
            // --- Â§âÊõ¥ÁÇπ („Éã„ÉÉ„ÇØ„Éç„Éº„É†Âá¶ÁêÜ) ---
            const baseNickname = serverNicknameInput.value.trim();
            let serverNicknameValue;
            if (baseNickname) {
                serverNicknameValue = `${baseNickname} | discord.gg/${config.invite_code}`;
            } else {
                serverNicknameValue = `discord.gg/${config.invite_code}`;
            }
            // ------------------------------
            
            // globalNicknameValue ÂâäÈô§
            const bioValue            = bioInput.value.trim();
            const boostOn             = boostCheckbox.checked;
            const reportOn            = reportCheckbox.checked; // ËøΩÂä†
            const doAutoReact         = Boolean(messageUrl);

            const doServerNickname    = true; // Â∏∏„Å´ÂÆüË°å„Åô„Çã
            // doGlobalNickname ÂâäÈô§
            // doAvatar ÂâäÈô§
            const doBio               = Boolean(bioValue);
            let guildId = null;
            let reactionInfo = null;

            try {
                const check = await fetch(`https://discord.com/api/v10/invites/${inviteCode}`);
                if (!check.ok) {
                    const errorData = await check.json().catch(() => ({ message: 'Unknown error' }));
                    appendLog(`‚ùå ÊãõÂæÖ„Ç≥„Éº„ÉâÁÑ°Âäπ: ${inviteCode} (Status: ${check.status}, Message: ${errorData.message || JSON.stringify(errorData)})`);
                    startBtn.disabled   = false;
                    startBtn.textContent = 'JoinÈñãÂßã';
                    startBtn.classList.remove('loading');
                    return;
                }
                const inviteData = await check.json();
                guildId = inviteData.guild?.id;
                if (!guildId) {
                    appendLog(`‚ùå ÊãõÂæÖ„Ç≥„Éº„Éâ„Åã„Çâ„Çµ„Éº„Éê„ÉºID„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ${inviteCode}`);
                }
                appendLog(`‚úÖ ÊãõÂæÖ„Ç≥„Éº„ÉâÊúâÂäπ: ${inviteCode}` + (guildId ? ` („Çµ„Éº„Éê„ÉºID: ${guildId})` : ' („Çµ„Éº„Éê„ÉºID‰∏çÊòé)'));
            } catch (e) {
                appendLog(`‚ö†Ô∏è ÊãõÂæÖ„Ç≥„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó: ${e}`);
                startBtn.disabled   = false;
                startBtn.textContent = 'JoinÈñãÂßã';
                startBtn.classList.remove('loading');
                return;
            }
            
            const joinPromises = tokens.map(token => {
                let joinerUrl = `https://ozeu-joiner.fly.dev/joiner?token=${encodeURIComponent(token)}&invite=${encodeURIComponent(inviteCode)}`;
                if (captchaApiKey) {
                    joinerUrl += `&api_key=${encodeURIComponent(captchaApiKey)}`;
                }
                if (reportOn) {
                    joinerUrl += `&report=true`;
                }
                return fetch(joinerUrl)
                    .then(async res => {
                        const body = await res.json().catch(() => null);
                        return { token, status: res.status, body };
                    })
                    .catch(err => ({ token, error: err }))
            });

            const joinResults = await Promise.all(joinPromises);

            const succeededTokens = [];
            const failedTokensArr = [];

            joinResults.forEach(r => {
                if (r.status === 200 && r.body?.status_code === 200) {
                    succeededTokens.push(r.token);
                    if (reportOn) {
                        appendLog(`‚úÖ Join / ReportÊàêÂäü: ${r.token.slice(0,10)}*****`);
                    } else {
                        appendLog(`‚úÖ JoinÊàêÂäü: ${r.token.slice(0,10)}*****`);
                    }

                } else {
                    failedTokensArr.push(r.token);
                    const info = r.body ? JSON.stringify(r.body) : String(r.error || r.status);
                    if (info.includes('"captcha_key"')) {
                        appendLog(`‚ùå CAPTCHA (Join): ${r.token.slice(0,10)}*****`);
                    } else {
                        appendLog(`‚ùå Â§±Êïó (Join): ${r.token.slice(0,10)}***** ‚Üí ${info}`);
                    }
                }
            });

            successArea.value = succeededTokens.join('\n');
            failedArea.value  = failedTokensArr.join('\n');
            if (succeededTokens.length === 0) {
                appendLog('‚ùå „Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåJoin„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                startBtn.disabled   = false;
                startBtn.textContent = 'JoinÈñãÂßã';
                startBtn.classList.remove('loading');
                return;
            }
            // --- Advanced Options Processing ---
            if (doAutoReact && succeededTokens.length > 0) {
                try {
                    reactionInfo = await getTopReactionFromMessage(messageUrl, succeededTokens[0]);
                    appendLog(`‚úÖ „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÊÉÖÂ†±ÂèñÂæóÊàêÂäü: ${reactionInfo.emojiName}`);
                } catch (error) {
                    appendLog(`‚ö†Ô∏è „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÊÉÖÂ†±ÂèñÂæóÂ§±Êïó: ${error.message}`);
                }
            }
            // 1. „Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥
            // --- Â§âÊõ¥ÁÇπ (ifÊù°‰ª∂) ---
            if (guildId && succeededTokens.length > 0) {
            // ---------------------
                const serverNickPromises = succeededTokens.map(async token => {
                    try {
                        const nickRes = await fetch(`https://discord.com/api/v10/guilds/${guildId}/members/@me`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': token,
                                'Content-Type': 'application/json',
                                "user-agent": user_agent,
                                "x-super-properties": x_super_properties
                            },
                            body: JSON.stringify({ nick: serverNicknameValue }) // Âä†Â∑•Ê∏à„Åø„ÅÆÂÄ§„Çí‰ΩøÁî®
                        });
                        if (nickRes.ok) {
                            appendLog(`‚úÖ „Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥ÊàêÂäü: ${token.slice(0,10)}***** ‚Üí "${serverNicknameValue}"`);
                        } else {
                            const errBody = await nickRes.json().catch(() => null);
                            const info    = errBody ? JSON.stringify(errBody) : nickRes.status;
                            appendLog(`‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥Â§±Êïó: ${token.slice(0,10)}***** ‚Üí ${info}`);
                        }
                    } catch (err) {
                        appendLog(`üí• „Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥„Ç®„É©„Éº: ${token.slice(0,10)}***** ‚Üí ${err}`);
                    }
                });
                await Promise.all(serverNickPromises);
            // --- Â§âÊõ¥ÁÇπ (else ifÊù°‰ª∂) ---
            } else if (!guildId) {
            // --------------------------
                appendLog('‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥„Çπ„Ç≠„ÉÉ„Éó: „Çµ„Éº„Éê„ÉºID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }

            // 2. „Ç∞„É≠„Éº„Éê„É´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†± (ÂêçÂâç„Éª„Ç¢„Ç§„Ç≥„É≥) Â§âÊõ¥
            // --- ÂâäÈô§ („Éñ„É≠„ÉÉ„ÇØÂÖ®‰Ωì) ---
            
            // 3. „Éó„É≠„Éï„Ç£„Éº„É´„É°„ÉÉ„Çª„Éº„Ç∏Â§âÊõ¥
            if (doBio && succeededTokens.length > 0) {
                appendLog('üîÑ „Éó„É≠„Éï„Ç£„Éº„É´„É°„ÉÉ„Çª„Éº„Ç∏Â§âÊõ¥Âá¶ÁêÜ„ÇíÈñãÂßã...');
                const bioPromises = succeededTokens.map(async token => {
                    try {
                        const profileRes = await fetch(`https://discord.com/api/v9/users/@me/profile`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': token,
                                'Content-Type': 'application/json',
                                "user-agent": user_agent,
                                "x-super-properties": x_super_properties
                            },
                            body: JSON.stringify({ bio: bioValue })
                        });
                        if (profileRes.ok) {
                            appendLog(`‚úÖ BioÂ§âÊõ¥ÊàêÂäü: ${token.slice(0,10)}***** ‚Üí "${bioValue}"`);
                        } else {
                            const errBody = await profileRes.json().catch(() => null);
                            const info    = errBody ? JSON.stringify(errBody) : profileRes.status;
                            appendLog(`‚ö†Ô∏è BioÂ§âÊõ¥Â§±Êïó: ${token.slice(0,10)}***** ‚Üí ${info}`);
                        }
                    } catch (err) {
                        appendLog(`üí• BioÂ§âÊõ¥„Ç®„É©„Éº: ${token.slice(0,10)}***** ‚Üí ${err}`);
                    }
                });
                await Promise.all(bioPromises);
            }

            // 4. „Çµ„Éº„Éê„Éº„Éñ„Éº„Çπ„ÉàÂá¶ÁêÜ
            if (boostOn && guildId && succeededTokens.length > 0) {
                appendLog('üöÄ „Çµ„Éº„Éê„Éº„Éñ„Éº„Çπ„ÉàÂá¶ÁêÜ„ÇíÈñãÂßã...');
                const boostPromises = succeededTokens.map(async token => {
                    try {
                        const slotsRes = await fetch(
                            'https://discord.com/api/v9/users/@me/guilds/premium/subscription-slots',
                            { headers: { 'Authorization': token } }
                        );
                        if (!slotsRes.ok) {
                            appendLog(`‚ö†Ô∏è „Çπ„É≠„ÉÉ„ÉàÂèñÂæóÂ§±Êïó (${slotsRes.status}): ${token.slice(0,10)}*****`);
                            return;
                        }

                        const slotsData = await slotsRes.json().catch(() => []);
                        if (!Array.isArray(slotsData) || slotsData.length === 0) {
                            appendLog(`‚ÑπÔ∏è „Éñ„Éº„Çπ„ÉàÁî®„Çπ„É≠„ÉÉ„Éà„Å™„Åó(„Éá„Éº„ÇøÁÑ°): ${token.slice(0,10)}*****`);
                            return;
                        }
                        
                        const freeSlots = slotsData.filter(item => item.premium_guild_subscription === null);
                        const freeCount = freeSlots.length;

                        if (freeCount === 0) {
                            appendLog(`‚ÑπÔ∏è Âà©Áî®ÂèØËÉΩ„Å™„Éñ„Éº„Çπ„Éà„Å™„Åó: ${token.slice(0,10)}***** (ÂÖ®${slotsData.length}„Çπ„É≠„ÉÉ„Éà‰ΩøÁî®‰∏≠)`);
                            return;
                        }

                        const slotIds = freeSlots.map(item => item.id);
                        appendLog(`‚ÑπÔ∏è ${token.slice(0,10)}***** „Å´ ${freeCount}ÂÄã„ÅÆÁ©∫„Åç„Éñ„Éº„Çπ„Éà„Çπ„É≠„ÉÉ„ÉàÊ§úÂá∫„ÄÇ`);

                        const boostRes = await fetch(
                            `https://discord.com/api/v9/guilds/${guildId}/premium/subscriptions`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': token,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    user_premium_guild_subscription_slot_ids: slotIds,
                                    disable_powerup_auto_apply: false
                                })
                            }
                        );

                        if (boostRes.ok) {
                            appendLog(`üöÄ ${freeCount} „Éñ„Éº„Çπ„ÉàÊàêÂäü: ${token.slice(0,10)}*****`);
                        } else {
                            const errBody = await boostRes.json().catch(() => null);
                            const info    = errBody ? JSON.stringify(errBody) : boostRes.status;
                            appendLog(`‚ö†Ô∏è „Éñ„Éº„Çπ„ÉàÂ§±Êïó: ${token.slice(0,10)}***** ‚Üí ${info}`);
                        }
                    } catch (err) {
                        appendLog(`üí• „Éñ„Éº„Çπ„ÉàÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº: ${token.slice(0,10)}***** ‚Üí ${err}`);
                    }
                });
                await Promise.all(boostPromises);
            } else if (boostOn && !guildId) {
                appendLog('‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Éñ„Éº„Çπ„Éà„Çπ„Ç≠„ÉÉ„Éó: „Çµ„Éº„Éê„ÉºID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }

            // 5. Ëá™Âãï„É™„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ
            if (doAutoReact && reactionInfo && succeededTokens.length > 0) {
                appendLog('üëç „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ„ÇíÈñãÂßã...');
                const reactPromises = succeededTokens.map(async token => {
                    try {
                        const result = await addReactionToMessage(
                            reactionInfo.channelId,
                            reactionInfo.messageId,
                            reactionInfo.emojiEncoded,
                            token
                        );
                        
                        if (result.success) {
                            appendLog(`‚úÖ „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÊàêÂäü: ${token.slice(0,10)}***** ‚Üí ${reactionInfo.emojiName}`);
                        } else {
                            const errorInfo = result.error || `${result.status} ${result.statusText}`;
                            appendLog(`‚ö†Ô∏è „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Â§±Êïó: ${token.slice(0,10)}***** ‚Üí ${errorInfo}`);
                        }
                    } catch (err) {
                        appendLog(`üí• „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ„Ç®„É©„Éº: ${token.slice(0,10)}***** ‚Üí ${err}`);
                    }
                });
                await Promise.all(reactPromises);
            }

            appendLog('üéâ ÂÖ®Âá¶ÁêÜÂÆå‰∫Ü');
            startBtn.disabled   = false;
            startBtn.textContent = 'JoinÈñãÂßã';
            startBtn.classList.remove('loading');
        });

        const detailsElement = document.querySelector('details');
        if (detailsElement) {
            detailsElement.addEventListener('toggle', () => {
                if (detailsElement.open) {
                    const optionItems = detailsElement.querySelectorAll('.option-item');
                    optionItems.forEach(item => {
                        item.style.animation = 'none';
                        item.offsetHeight; 
                        item.style.animation = ''; 
                    });
                }
            });
        }
    </script>
</body>
</html>